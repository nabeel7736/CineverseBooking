<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Manage Shows | CineVerse Admin</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* --- CineVerse Admin Theme --- */
    :root{
      --accent:#ff3d00;
      --accent-dark:#e13500;
      --sidebar-bg:#121212;
      --muted:#c7c7c7;
      --card-bg:#fff;
    }

    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f4f4f9;
      margin:0;
    }

    /* Sidebar */
    .sidebar {
      width: 250px;
      height: 100vh;
      background: var(--sidebar-bg);
      position: fixed;
      top: 0;
      left: 0;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      box-shadow:2px 0 15px rgba(0,0,0,0.25);
      padding:25px 0;
      z-index: 10;
    }
    .sidebar h3{
      color: var(--accent);
      text-align:center;
      font-weight:700;
      margin-bottom:2rem;
      letter-spacing:1px;
    }
    .sidebar a{
      color: var(--muted);
      display:block;
      padding:12px 25px;
      text-decoration:none;
      font-weight:500;
      border-left:4px solid transparent;
      transition: all .25s ease;
    }
    .sidebar a:hover,
    .sidebar a.active{
      background:#1f1f1f;
      color:#fff;
      border-left:4px solid var(--accent);
      transform: translate(-1px,0px);
-webkit-transform: translate(-1px,0px);
-moz-transform: translate(-1px,0px);
    }
    .sidebar hr{ border-color:#2c2c2c; margin:1.5rem 0; }

    /* Content */
    .content {
      margin-left:250px;
      padding:3rem 2rem;
      min-height:100vh;
    }

    h2{
      font-weight:700;
      color:#222;
      margin-bottom:1.25rem;
    }

    .card {
      background: var(--card-bg);
      border: none;
      border-radius: 15px;
      box-shadow: 0 3px 15px rgba(0,0,0,0.08);
    }

    .btn-accent {
      background: linear-gradient(90deg, var(--accent), #ff6a2e);
      color: #fff;
      border: none;
      box-shadow: 0 4px 12px rgba(255,61,0,0.12);
    }
    .btn-accent:hover{ background: var(--accent-dark); }

    .form-control:focus{
      border-color: var(--accent);
      box-shadow: 0 0 6px rgba(255,61,0,0.2);
    }

    .table thead { background: var(--sidebar-bg); color: #fff; }
    .table tbody tr:nth-of-type(odd) { background: #fbfbfc; }

    /* poster thumbnail */
    .poster-thumb {
      width:48px;
      height:72px;
      object-fit:cover;
      border-radius:4px;
      box-shadow:0 1px 6px rgba(0,0,0,0.12);
    }

    /* seat layout preview modal */
    .seat-grid { display:grid; gap:6px; justify-content:center; align-items:center; }
    .seat { width:28px; height:28px; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:11px; cursor:default; user-select:none; }
    .seat.available { background:#e6f7e6; border:1px solid #b6e6b6; color:#225522; }
    .seat.booked { background:#ffdede; border:1px solid #ff9e9e; color:#7a1a1a; }
    .seat.header { font-weight:700; background:transparent; border:none; color:#333; }

    @media (max-width: 1200px) {
      .poster-thumb { width:40px; height:60px; }
      .seat { width:24px; height:24px; font-size:10px; }
    }

    @media (max-width: 992px) {
      .sidebar { width:200px; }
      .content { margin-left:200px; padding:2rem 1rem; }
    }
    @media (max-width: 768px) {
      .sidebar { position:relative; width:100%; height:auto; }
      .content { margin-left:0; padding:1.25rem; }
    }

    /* small helpers */
    .muted { color: #6c757d; font-size:0.9rem; }
    .small-muted { font-size:0.85rem; color:#888; }

    /* seat layout preview modal */
    .seat-grid { display:grid; gap:6px; } /* Removed centering on grid, replaced by flex container */
    .seat { width:28px; height:28px; border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:10px; cursor:default; user-select:none; padding: 2px; } /* Adjusted font size for A10 */
    .seat.available { background:#e6f7e6; border:1px solid #b6e6b6; color:#225522; }
    .seat.booked { background:#ffdede; border:1px solid #ff9e9e; color:#7a1a1a; }
    .seat.header { font-weight:700; background:transparent; border:none; color:#333; }

    /* New Screen Model Style */
    .screen-model {
      background: #333;
      color: #fff;
      padding: 5px;
      text-align: center;
      font-weight: 600;
      border-radius: 8px;
      border-top-left-radius: 40px;
      border-top-right-radius: 40px;
      box-shadow: 0 5px 10px rgba(0,0,0,0.3);
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 20px;
    }

    /* Small gap between the two seat sections for the "aisle" */
    .seat-halves {
        display: flex;
        justify-content: center;
        gap: 20px;
    }

  </style>
</head>
<body>
  <div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar">
      <div>
        <h3>CineVerse</h3>
        <a href="/admin/dashboard">Dashboard</a>
        <a href="/admin/movies">Manage Movies</a>
        <a href="/admin/shows" class="active">Manage Shows</a>
        <a href="/admin/bookings">Bookings</a>
        <a href="/admin/users">Users</a>
      </div>
      <div>
        <hr />
      </div>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="d-flex align-items-center justify-content-between mb-4 gap-2 flex-wrap">
        <div>
          <h2>Manage Shows</h2>
          <div class="muted">Create and manage movie shows — pick theatre & screen, set time, price and seats.</div>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-secondary" id="refreshBtn" title="Refresh shows">Refresh</button>
          <button class="btn btn-accent" data-bs-toggle="modal" data-bs-target="#addShowModal">+ Add Show</button>
        </div>
      </div>

      <div class="card p-4 mb-4">
        <!-- filters row (optional) -->
        <div class="row mb-3 g-2">
          <div class="col-md-4">
            <input id="searchInput" class="form-control" placeholder="Search movie or theatre..." />
          </div>
          <div class="col-md-3">
            <select id="filterTheatre" class="form-control">
              <option value="">All Theatres</option>
            </select>
          </div>
          <div class="col-md-3">
            <select id="filterScreen" class="form-control">
              <option value="">All Screens</option>
            </select>
          </div>
          <div class="col-md-2 text-end">
            <button class="btn btn-outline-secondary" id="applyFilters">Apply</button>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-striped table-bordered align-middle">
            <thead>
              <tr>
                <th>ID</th>
                <th>Movie</th>
                <th>Theatre</th>
                <th>Screen</th>
                <th>Date</th>
                <th>Time</th>
                <th>Language</th>
                <th>Price</th>
                <th>Seats Total</th>
                <th>Seats Booked</th>
                <th>Seats Left</th>
                <th>Preview</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="showsTableBody">
              <!-- populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Show Modal -->
  <div class="modal fade" id="addShowModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content rounded-3">
        <div class="modal-header bg-light">
          <h5 class="modal-title">Add New Show</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <form id="addShowForm" class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Select Movie</label>
              <select id="movie_id" class="form-control" required>
                <option value="">Loading movies...</option>
              </select>
              <div class="small-muted mt-1" id="addMoviePosterPreviewWrap" style="display:none;">
                <img id="addMoviePosterPreview" class="poster-thumb" alt="poster" />
                <span class="ms-2 small-muted" id="addMoviePosterTitle"></span>
                <button type="button" class="btn btn-sm btn-outline-secondary ms-3" id="addPreviewPosterBtn">Open poster</button>
              </div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Select Theatre</label>
              <select id="theatre_id" class="form-control" required>
                <option value="">Loading theatres...</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Select Screen</label>
              <select id="screen_id" class="form-control" required>
                <option value="">Select theatre first</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Start Time</label>
              <input type="datetime-local" id="start_time" class="form-control" name="start_time" required />
            </div>

            <div class="col-md-4">
              <label class="form-label">Language</label>
              <select id="language" class="form-control" required>
                <option value="">Select Language</option>
                <option value="English">English</option>
                <option value="Malayalam">Malayalam</option>
                <option value="Hindi">Hindi</option>
                <option value="Tamil">Tamil</option>
                <option value="Telugu">Telugu</option>
                <option value="Other">Other</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Price (₹)</label>
              <select id="price" class="form-control" required>
                <option value="">Select Price</option>
                <option value="150.00">₹120.00</option>
                <option value="200.00">₹150.00</option>
                <option value="250.00">₹200.00</option>
                <option value="300.00">₹250.00</option>
              </select>
            </div>

            <div class="col-md-4">
              <label class="form-label">Total Seats</label>
              <!-- readonly so auto-filled from selected screen -->
              <input type="number" id="seats_total" class="form-control" required readonly />
            </div>

            <div class="col-12 text-end mt-2">
              <button type="submit" class="btn btn-accent px-4">Add Show</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Show Modal -->
  <div class="modal fade" id="editShowModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content rounded-3">
        <div class="modal-header bg-light">
          <h5 class="modal-title">Edit Show</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <form id="editShowForm" class="row g-3">
            <input type="hidden" id="edit_id" />
            <div class="col-md-6">
              <label class="form-label">Select Theatre</label>
              <select id="edit_theatre_id" class="form-control"></select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Select Screen</label>
              <select id="edit_screen_id" class="form-control"></select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Start Time</label>
              <input type="datetime-local" id="edit_start_time" class="form-control" name="start_time" required />
            </div>

            <div class="col-md-3">
              <label class="form-label">Price (₹)</label>
              <input type="number" id="edit_price" class="form-control" required />
            </div>

            <div class="col-md-3">
              <label class="form-label">Seats Total</label>
              <input type="number" id="edit_seats_total" class="form-control" required readonly />
            </div>

            <div class="col-12 text-end mt-2">
              <button type="submit" class="btn btn-accent px-4">Update Show</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Poster lightbox modal -->
  <div class="modal fade" id="posterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
      <div class="modal-content p-2">
        <img id="posterModalImg" src="" alt="poster" style="width:100%; height:auto; display:block; border-radius:6px;" />
      </div>
    </div>
  </div>

  <!-- Seat Layout Preview Modal -->
  <div class="modal fade" id="seatPreviewModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-md">
      <div class="modal-content p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">Seat Layout Preview</h6>
          <small id="seatPreviewInfo" class="small-muted"></small>
        </div>
        <div id="seatGridWrap" class="text-center">
          <!-- grid inserted dynamically -->
        </div>
        <div class="mt-3 text-end">
          <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
 
    // prefer access_token (per your setup), fallback to adminToken
    const token = localStorage.getItem('access_token') || localStorage.getItem('adminToken') || '';

    const API_MOVIES = '/api/admin/movies';
    const API_THEATRES = '/api/admin/theatres';
    const API_SHOWS = '/api/admin/shows';

    // --- Helpers
    function el(tag, cls){ const e = document.createElement(tag); if (cls) e.className = cls; return e; }
    function parseDate(value){
      if (!value) return null;
      const d = new Date(value);
      if (!isNaN(d.getTime())) return d;
      return null;
    }
    function fmtDateISOToLocalInputs(iso){
      const d = parseDate(iso);
      if (!d) return '';
      const pad = n => n.toString().padStart(2,'0');
      const yyyy = d.getFullYear();
      const mm = pad(d.getMonth()+1);
      const dd = pad(d.getDate());
      const hh = pad(d.getHours());
      const mi = pad(d.getMinutes());
      return `${yyyy}-${mm}-${dd}T${hh}:${mi}`;
    }
    function fmtDisplayDate(value){
      const d = parseDate(value);
      if (!d) return 'Invalid';
      return d.toLocaleDateString('en-IN');
    }
    function fmtDisplayTime(value){
      const d = parseDate(value);
      if (!d) return 'Invalid';
      return d.toLocaleTimeString('en-IN', {hour:'2-digit', minute:'2-digit'});
    }

    // --- Load Movies
    async function loadMovies() {
      const sel = document.getElementById('movie_id');
      sel.innerHTML = '<option>Loading movies...</option>';
      try {
        const res = await fetch(API_MOVIES, { headers: { 'Authorization': `Bearer ${token}` }});
        if (!res.ok) throw new Error('Failed to fetch movies');
        const json = await res.json();
        const arr = Array.isArray(json) ? json : (json.movies || json.data || json || []);
        sel.innerHTML = '<option value="">Select Movie</option>';
        arr.forEach(m => {
          const opt = document.createElement('option');
          opt.value = m.id ?? m.ID ?? m.Id;
          opt.textContent = m.title ?? m.Title ?? m.name ?? 'Untitled';
          // store poster url for preview
          if (m.posterUrl) opt.dataset.poster = m.posterUrl;
          else if (m.poster) opt.dataset.poster = m.poster;
          sel.appendChild(opt);
        });
      } catch (err) {
        console.error('loadMovies err', err);
        sel.innerHTML = '<option value="">Failed to load</option>';
      }
    }


    // --- Load Theatres
    async function loadTheatres() {
      try {
        const res = await fetch(API_THEATRES, { headers: { 'Authorization': `Bearer ${token}` }});
        if (!res.ok) throw new Error('Failed to fetch theatres');
        const theatres = await res.json();
        const list = Array.isArray(theatres) ? theatres : (theatres.data || theatres || []);
        const sel = document.getElementById('theatre_id');
        const selEdit = document.getElementById('edit_theatre_id');
        const filterTheatre = document.getElementById('filterTheatre');
        [sel, selEdit, filterTheatre].forEach(s => {
          if (!s) return;
          s.innerHTML = '<option value="">Select Theatre</option>';
        });

        list.forEach(t => {
          const id = t.id ?? t.ID ?? t.Id;
          const label = `${t.name} (${t.location || ''})`;
          [sel, selEdit, filterTheatre].forEach(s => {
            if (!s) return;
            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = label;
            s.appendChild(opt);
          });
        });

      } catch (err) {
        console.error('loadTheatres err', err);
      }
    }

    // --- Load screens for a theatre into a specific select element
    // each option will include data-seats attribute so we can auto-fill total seats
    async function loadScreensForTheatre(theatreId, targetSelectId) {
      const sel = document.getElementById(targetSelectId);
      if (!sel) return;
      sel.innerHTML = '<option>Loading screens...</option>';
      if (!theatreId) {
        sel.innerHTML = '<option value="">Select theatre first</option>';
        return;
      }
      try {
        const res = await fetch(`${API_THEATRES}/${theatreId}/screens`, { headers: { 'Authorization': `Bearer ${token}` }});
        if (!res.ok) throw new Error('Failed to fetch screens');
        const screens = await res.json();
        const arr = Array.isArray(screens) ? screens : (screens.data || screens || []);
        sel.innerHTML = '<option value="">Select Screen</option>';
        arr.forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.id ?? s.ID ?? s.Id;
          const seatsCount = s.seats_total ?? s.SeatsTotal ?? s.seats ?? '';
  opt.textContent = `${s.name} (${seatsCount || '—'} seats)`;
          if (seatsCount !== undefined && seatsCount !== null) opt.dataset.seats = seatsCount; // Stores capacity
  sel.appendChild(opt);
        });
      } catch (err) {
        console.error('loadScreens err', err);
        sel.innerHTML = '<option value="">Failed to load</option>';
      }
    }

    // When a screen is selected in Add modal, auto-fill seats_total
    document.getElementById('screen_id').addEventListener('change', function () {
  const selected = this.options[this.selectedIndex];
  const seats = selected?.dataset?.seats ?? ''; // Reads capacity from data-seats
  const seatsInput = document.getElementById('seats_total');
  if (seatsInput) seatsInput.value = seats; // Sets input value
});

    // When a screen is selected in Edit modal, auto-fill edit_seats_total
    document.getElementById('edit_screen_id').addEventListener('change', function () {
      const selected = this.options[this.selectedIndex];
      const seats = selected?.dataset?.seats ?? '';
      const seatsInput = document.getElementById('edit_seats_total');
      if (seatsInput) seatsInput.value = seats;
    });

    // Wire theatre -> screen dependency for modal and edit modal and filters
    document.addEventListener('change', (e) => {
      if (e.target && e.target.id === 'theatre_id') {
        loadScreensForTheatre(e.target.value, 'screen_id').then(() => {
          const sel = document.getElementById('screen_id');
          if (sel && sel.value) {
            const option = sel.options[sel.selectedIndex];
            document.getElementById('seats_total').value = option?.dataset?.seats ?? '';
          } else {
            document.getElementById('seats_total').value = '';
          }
        });
      }
      if (e.target && e.target.id === 'edit_theatre_id') {
        loadScreensForTheatre(e.target.value, 'edit_screen_id').then(() => {
          const sel = document.getElementById('edit_screen_id');
          if (sel && sel.value) {
            const option = sel.options[sel.selectedIndex];
            document.getElementById('edit_seats_total').value = option?.dataset?.seats ?? '';
          } else {
            document.getElementById('edit_seats_total').value = '';
          }
        });
      }
      if (e.target && e.target.id === 'filterTheatre') {
        const theatreId = e.target.value;
        const filterScreen = document.getElementById('filterScreen');
        if (!filterScreen) return;
        if (!theatreId) {
          filterScreen.innerHTML = '<option value="">All Screens</option>';
          return;
        }
        loadScreensForTheatre(theatreId, 'filterScreen');
      }
    });

    // --- Add show (modal form)
    document.getElementById('addShowForm').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const payload = {
        movie_id: parseInt(document.getElementById('movie_id').value || 0),
        theatre_id: parseInt(document.getElementById('theatre_id').value || 0),
        screen_id: parseInt(document.getElementById('screen_id').value || 0),
        start_time:new Date (document.getElementById('start_time').value).toISOString(),
        language: document.getElementById('language').value,
        price: parseFloat(document.getElementById('price').value || 0),
        seats_total: parseInt(document.getElementById('seats_total').value || 0)
      };

      // basic validation
      if (!payload.movie_id || !payload.screen_id || !payload.start_time) {
        alert('Please select movie, theatre/screen and start time.');
        return;
      }

      try {
        const res = await fetch(API_SHOWS, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify(payload)
        });
        if (res.ok) {
          const modalEl = document.getElementById('addShowModal');
          const modal = bootstrap.Modal.getInstance(modalEl);
          modal.hide();
          ev.target.reset();
          document.getElementById('seats_total').value = '';
          loadShows();
          alert('Show added.');
        } else {
          const err = await res.json().catch(()=>({}));
          alert(err.error || err.message || 'Failed to add show.');
        }
      } catch (err) {
        console.error('add show err', err);
        alert('Network error while adding show.');
      }
    });

    // --- Edit show - prefill modal
    function openEditModal(showObj) {
        console.log("Edit Modal Data:", showObj);
      const id = showObj.id ?? showObj.ID ?? showObj.Id;
      document.getElementById('edit_id').value = id;

      // Prefer explicit fields if present, otherwise try nested screen/theatre
      const theatreId = showObj.theatre_id ?? showObj.theatre?.id ?? showObj.screen?.theatre?.id;
      const screenId = showObj.screen_id ?? showObj.screen?.id;

      if (theatreId) {
        document.getElementById('edit_theatre_id').value = theatreId;
        loadScreensForTheatre(theatreId, 'edit_screen_id').then(() => {
          if (screenId) {
            document.getElementById('edit_screen_id').value = screenId;
            const sel = document.getElementById('edit_screen_id');
            const opt = sel.options[sel.selectedIndex];
            document.getElementById('edit_seats_total').value = opt?.dataset?.seats ?? (showObj.seats_total ?? '');
          } else {
            document.getElementById('edit_seats_total').value = showObj.seats_total ?? '';
          }
        });
      } else {
        // fallback
        document.getElementById('edit_seats_total').value = showObj.seats_total ?? '';
      }

      document.getElementById('edit_start_time').value = fmtDateISOToLocalInputs(showObj.start_time ?? showObj.startTime ?? showObj.StartTime);
      document.getElementById('edit_price').value = showObj.price ?? showObj.Price ?? '';

      const modal = new bootstrap.Modal(document.getElementById('editShowModal'));
      modal.show();
    }

    // Submit edit
    document.getElementById('editShowForm').addEventListener('submit', async (ev) => {
  ev.preventDefault();

  const screenId = parseInt(document.getElementById('edit_screen_id').value);
  if (!screenId || screenId === 0) {
    alert("Please select a valid screen before updating.");
    return;
  }

  const id = document.getElementById('edit_id').value;
  const payload = {
    screen_id: screenId,
    start_time: new Date(document.getElementById('edit_start_time').value).toISOString(),
    price: parseFloat(document.getElementById('edit_price').value || 0),
    seats_total: parseInt(document.getElementById('edit_seats_total').value || 0)
  };

  try {
    const res = await fetch(`${API_SHOWS}/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      bootstrap.Modal.getInstance(document.getElementById('editShowModal')).hide();
      loadShows();
      alert('Show updated successfully!');
    } else {
      const err = await res.json().catch(() => ({}));
      alert(err.error || err.message || 'Failed to update show.');
    }
  } catch (err) {
    console.error('update show err', err);
    alert('Network error while updating show.');
  }
});


    // --- Delete show
    async function deleteShow(id) {
      if (!confirm('Are you sure you want to delete this show?')) return;
      try {
        const res = await fetch(`${API_SHOWS}/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
          loadShows();
          alert('Show deleted.');
        } else {
          const err = await res.json().catch(()=>({}));
          alert(err.error || 'Failed to delete.');
        }
      } catch (err) {
        console.error('delete show err', err);
        alert('Network error while deleting show.');
      }
    }

    // --- Seat layout preview
    // `showObj` should provide seats_total and seats_booked optionally
   function openSeatPreview(showObj) {
      const seatsTotal = parseInt(showObj.seats_total ?? showObj.SeatsTotal ?? showObj.available_seats ?? 0);
      
      // Get the actual list of confirmed seat codes
      const bookedCodes = showObj.booked_seat_codes || [];
      const actualBookedCount = bookedCodes.length;
      const actualSeatsLeft = Math.max(0, seatsTotal - actualBookedCount);

      const wrap = document.getElementById('seatGridWrap');
      wrap.innerHTML = '';

      const info = document.getElementById('seatPreviewInfo');
      // Update info line to reflect accurate confirmed counts
      info.textContent = `Total ${seatsTotal} • Booked ${actualBookedCount} • Left ${actualSeatsLeft}`;

      if (!seatsTotal || seatsTotal <= 0) {
        wrap.innerHTML = '<div class="muted">No seat information available for this show.</div>';
        const modal = new bootstrap.Modal(document.getElementById('seatPreviewModal'));
        modal.show();
        return;
      }

      const screenModel = el('div', 'screen-model');
        screenModel.textContent = 'Screen';
        wrap.appendChild(screenModel);

        const ROWS_LETTERS = ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J"]; // Up to 10 rows
        const TOTAL_COLS = 12; // Example: 12 seats per row
        const SEATS_PER_ROW = TOTAL_COLS;
        const HALF_COLS = SEATS_PER_ROW / 2;

        const numRowsToDisplay = Math.min(ROWS_LETTERS.length, Math.ceil(seatsTotal / SEATS_PER_ROW));

        // Create the container for two halves
        const gridContainer = el('div', 'seat-halves'); // Custom class for flex layout
        
        const gridLeft = el('div', 'seat-grid');
        gridLeft.style.gridTemplateColumns = `repeat(${HALF_COLS}, auto)`;
        gridContainer.appendChild(gridLeft);
        
        const gridRight = el('div', 'seat-grid');
        gridRight.style.gridTemplateColumns = `repeat(${HALF_COLS}, auto)`;
        gridContainer.appendChild(gridRight);
        
        // Append grid container to wrapper
        wrap.appendChild(gridContainer);


        let seatIndex = 0; // Tracks which seat we are on (1 to seatsTotal)
        const bookedCodeSet = new Set(bookedCodes); // Set for fast lookup of confirmed seats

        for (let r = 0; r < numRowsToDisplay; r++) {
            const rowCode = ROWS_LETTERS[r];
            
            for (let c = 1; c <= SEATS_PER_ROW; c++) {
                if (seatIndex >= seatsTotal) break; // Stop after total seats reached
                
                const seatCode = rowCode + c;
                
                const seat = el('div', 'seat');
                
                // Check if this specific code is in the confirmed list
                const isBooked = bookedCodeSet.has(seatCode); 

                seat.classList.add(isBooked ? 'booked' : 'available');
                seat.title = seatCode;
                seat.textContent = seatCode; // Seat name: A1, A2, etc.
                
                // Split half of two sides
                if (c <= HALF_COLS) {
                    gridLeft.appendChild(seat);
                } else {
                    gridRight.appendChild(seat);
                }
                seatIndex++; // Increment the counter
            }
        }

      const modal = new bootstrap.Modal(document.getElementById('seatPreviewModal'));
      modal.show();
    }

    // --- Load shows into table
    async function loadShows() {
      const tbody = document.getElementById('showsTableBody');
      tbody.innerHTML = `<tr><td colspan="14" class="text-center muted">Loading shows...</td></tr>`;
      try {
        const search = (document.getElementById('searchInput') || {}).value || '';
        const theatreFilter = (document.getElementById('filterTheatre') || {}).value || '';
        const screenFilter = (document.getElementById('filterScreen') || {}).value || '';

        const params = new URLSearchParams();
        if (search) params.append('search', search);
        if (theatreFilter) params.append('theatre_id', theatreFilter);
        if (screenFilter) params.append('screen_id', screenFilter);

        const res = await fetch(`${API_SHOWS}?${params.toString()}`, { headers: { 'Authorization': `Bearer ${token}` }});
        if (!res.ok) throw new Error('Failed to fetch shows');
        const json = await res.json();

        let list = json.shows ?? json.data ?? json ?? [];
        if (!Array.isArray(list)) {
          // try to find first array in response
          for (const k in json) if (Array.isArray(json[k])) { list = json[k]; break; }
        }

        if (!list || list.length === 0) {
          tbody.innerHTML = `<tr><td colspan="14" class="text-center muted">No shows found</td></tr>`;
          return;
        }

        tbody.innerHTML = '';
        list.forEach(s => {
          // Support multiple shapes returned by backend
          const id = s.id ?? s.ID ?? s.Id ?? '-';
          const movieTitle = s.movie_title ?? s.movie?.title ?? s.movieTitle ?? (s.movie && s.movie.Title) ?? '-';
          // poster url if available (from nested movie or property)
          // const posterUrl = s.movie?.posterUrl ?? s.movie?.poster ?? s.posterUrl ?? s.poster ?? (s.movie && (s.movie.posterUrl || s.movie.poster));
          const theatre = (typeof s.theatre === 'string' ? s.theatre : (s.screen?.theatre?.name ?? s.theatre_name ?? s.theatre?.name ?? '-')) ?? '-';
          const screen = (typeof s.screen === 'string' ? s.screen : (s.screen?.name ?? s.screen_name ?? '-')) ?? '-';
          // start time and display
          const startVal = s.start_time ?? s.startTime ?? s.StartTime ?? (s.date && s.time ? `${s.date} :-T${s.time}` : null);
          const date = s.date ?? fmtDisplayDate(startVal);
          const time = s.time ?? fmtDisplayTime(startVal);
          const language = s.language?.trim()? s.language: (s.movie?.language ?? s.movie?.Language ?? '-');
          const price = (s.price ?? s.Price ?? s.ticket_price ?? '-') ;

          // seats
          // preferred: s.seats_total & s.seats_booked; fallback: available_seats from AdminListShows
         const seatsTotal = (s.seats_total ?? s.SeatsTotal ?? s.total_seats ?? s.totalSeats ?? null);
          const seatsBooked = (s.seats_booked ?? s.SeatsBooked ?? s.booked ?? s.booked_seats ?? null);
          const availableSeats = (s.available_seats ?? s.availableSeats ?? s.available ?? null); //

          // Compute displayed numbers:
          let total = 0, booked = 0, left = 0;
         
          total = parseInt(seatsTotal) || 0;
          booked = parseInt(seatsBooked) || 0;

          if (total > 0) {
            left = Math.max(0, total - booked);
          } else if (availableSeats !== null) {
             // If we only have available seats (for some reason), show that as left
             left = parseInt(availableSeats) || 0;
          }

          // create table row
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${id}</td>
            <td>${escapeHtml(movieTitle)}</td>
            <td>${escapeHtml(theatre)}</td>
            <td>${escapeHtml(screen)}</td>
            <td>${escapeHtml(date)}</td>
            <td>${escapeHtml(time)}</td>
            <td>${escapeHtml(language)}</td>
            <td>₹${price}</td>
            <td>${total}</td>
            <td>${booked}</td>
            <td>${left}</td>
            <td class="text-center">
              <button class="btn btn-sm btn-outline-secondary" data-action="previewSeats" data-show='${htmlSafeJson(s)}'>Preview</button>
            </td>
            <td>
              <div class="d-flex gap-1 justify-content-center">
                <button class="btn btn-sm btn-primary" title="Edit" data-action="editShow" data-show='${htmlSafeJson(s)}'>Edit</button>
                <button class="btn btn-sm btn-danger" title="Delete" data-action="deleteShow" data-id="${id}">Delete</button>
              </div>
            </td>
          `;
          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error('loadShows err', err);
        tbody.innerHTML = `<tr><td colspan="14" class="text-center text-danger">Failed to load shows</td></tr>`;
      }
    }

    // Utility: safely JSON.stringify a show object for embedding in data attribute
    function htmlSafeJson(obj) {
      try {
        return escapeHtml(JSON.stringify(obj));
      } catch (e) {
        return '';
      }
    }
    function escapeHtml(str) {
      if (typeof str !== 'string') return str;
      return str.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;').replaceAll("'", '&#39;');
    }

    // handle table-level clicks (edit, delete, preview)
    document.getElementById('showsTableBody').addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const action = btn.dataset.action;
      if (action === 'editShow') {
        const raw = btn.dataset.show;
        if (!raw) return;
        const obj = JSON.parse(unescapeHtml(raw));
        openEditModal(obj);
      } else if (action === 'deleteShow') {
        const id = btn.dataset.id;
        if (id) deleteShow(id);
      } else if (action === 'previewSeats') {
        const raw = btn.dataset.show;
        if (!raw) return;
        const obj = JSON.parse(unescapeHtml(raw));
        openSeatPreview(obj);
      }
    });

    // reverse of htmlSafeJson
    function unescapeHtml(str) {
      if (!str) return str;
      return str.replaceAll('&quot;', '"').replaceAll('&#39;', "'").replaceAll('&lt;', '<').replaceAll('&gt;', '>').replaceAll('&amp;', '&');
    }

    // wire the edit button (open modal with details) created above uses openEditModal via dataset

    // convenience: refresh & search wiring
    document.getElementById('refreshBtn').addEventListener('click', loadShows);
    document.getElementById('applyFilters').addEventListener('click', loadShows);
    document.getElementById('searchInput').addEventListener('keyup', (e) => {
      if (e.key === 'Enter') loadShows();
    });

    // initial load
    (async function init(){
      await loadMovies();
      await loadTheatres();
      // load screens for filterTheatre if any selected (keeps filter select usable)
      const ft = document.getElementById('filterTheatre').value;
      if (ft) await loadScreensForTheatre(ft, 'filterScreen');
      await loadShows();
    })();
  </script>
</body>
</html>
