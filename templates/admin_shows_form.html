
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
  <title>Manage Shows | CineVerse Admin</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #f4f4f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    .sidebar { width: 250px; height: 100vh; background: #121212; position: fixed; top: 0; left: 0; display:flex; flex-direction:column; justify-content:space-between; box-shadow:2px 0 15px rgba(0,0,0,0.25); padding:25px 0; }
    .sidebar h3 { color:#ff3d00; text-align:center; font-weight:700; margin-bottom:2rem; letter-spacing:1px; }
    .sidebar a { color:#c7c7c7; display:block; padding:12px 25px; text-decoration:none; font-weight:500; border-left:4px solid transparent; transition:all .25s ease; }
    .sidebar a:hover, .sidebar a.active { background:#1f1f1f; color:#fff; border-left:4px solid #ff3d00; }
    .sidebar hr { border-color:#2c2c2c; margin:1.5rem 0; }
    .sidebar button { margin:0 20px 10px; font-weight:500; }

    .content { margin-left:250px; padding:3rem 2rem; min-height:100vh; }
    h2 { font-weight:700; color:#222; margin-bottom:1.5rem; }
    .card { border:none; border-radius:15px; background:#fff; box-shadow:0 3px 15px rgba(0,0,0,0.08); transition:transform .2s ease, box-shadow .2s ease; }
    .card:hover { transform:translateY(-3px); box-shadow:0 6px 20px rgba(0,0,0,0.15); }
    .btn-primary { background:#ff3d00; border:none; }
    .btn-primary:hover { background:#e33500; }
    .form-control:focus { border-color:#ff3d00; box-shadow:0 0 6px rgba(255,61,0,0.4); }

    @media (max-width:992px){ .sidebar{ width:200px } .content{ margin-left:200px } }
    @media (max-width:768px){ .sidebar{ position:relative; width:100%; height:auto } .content{ margin-left:0; padding:2rem 1rem } }

    /* a little spacing for the Add Show button */
    .add-btn { background: linear-gradient(90deg,#ff3d00,#ff6a2e); color:#fff; border:none; padding:12px 20px; border-radius:8px; }
  </style>
</head>
<body>
  <div class="d-flex">
    <div class="sidebar">
      <div>
        <h3>CineVerse</h3>
        <a href="/admin/dashboard">Dashboard</a>
        <a href="/admin/movies">Manage Movies</a>
        <a href="/admin/shows" class="active">Manage Shows</a>
        <a href="/admin/bookings">Bookings</a>
        <a href="/admin/users">Users</a>
      </div>
      <div>
        <hr>
      </div>
    </div>

    <div class="content flex-grow-1">
      <div class="card p-4 mb-5">
        <h2>Add New Show</h2>
        <form id="showForm">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Select Movie</label>
              <select id="movie_id" class="form-control" required></select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Hall Name</label>
              <input id="hall" class="form-control" placeholder="Hall 1" required />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Date</label>
              <input id="date" type="date" class="form-control" required />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Time</label>
              <input id="time" type="time" class="form-control" required />
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Ticket Price (₹)</label>
              <input id="price" type="number" step="0.01" class="form-control" required />
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label fw-semibold">Total Seats</label>
              <input id="seats_total" type="number" class="form-control" required />
            </div>
          </div>

          <button type="submit" class="add-btn w-100">Add Show</button>
        </form>
      </div>

      <h2>Existing Shows</h2>
      <div class="row" id="showsContainer"></div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editShowModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content rounded-3">
        <div class="modal-header bg-light">
          <h5 class="modal-title">Edit Show</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="editShowForm">
            <input type="hidden" id="edit_id">
            <div class="mb-3">
              <label class="form-label fw-semibold">Hall</label>
              <input id="edit_hall" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Date</label>
              <input id="edit_date" type="date" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Time</label>
              <input id="edit_time" type="time" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Ticket Price</label>
              <input id="edit_price" type="number" step="0.01" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label fw-semibold">Total Seats</label>
              <input id="edit_seats" type="number" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Update Show</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const token = localStorage.getItem('access_token');
    if (!token) {
      // optional: remove if your admin page handles auth differently
      alert('Unauthorized! Please login as admin.');
      window.location.href = '/login';
    }

    const API_MOVIES = '/api/admin/movies';
    const API_SHOWS = '/api/admin/shows';

    // robust helpers for different backend shapes
    function getShowsFromResponse(data) {
      if (!data) return [];
      if (Array.isArray(data)) return data;
      if (Array.isArray(data.shows)) return data.shows;
      // if API returns { data: [...] } or other shapes:
      if (Array.isArray(data.data)) return data.data;
      // fallback: try to find first array value
      for (const k in data) {
        if (Array.isArray(data[k])) return data[k];
      }
      return [];
    }

    function getField(obj, ...keys) {
      for (const k of keys) {
        if (obj == null) continue;
        if (k in obj && obj[k] !== undefined && obj[k] !== null) return obj[k];
      }
      return undefined;
    }

    // parse various date formats safely
    function parseDate(value) {
      if (!value && value !== 0) return null;
      // value could be a string ISO, numeric timestamp, or object
      if (typeof value === 'string') {
        // cleanup whitespace
        const v = value.trim();
        // if looks like "/Date(1234567890)/" extract number
        const m = v.match(/\/Date\((\d+)\)\//);
        if (m) return new Date(parseInt(m[1], 10));
        // if numeric string
        if (/^\d+$/.test(v)) return new Date(parseInt(v, 10));
        const d = new Date(v);
        if (!isNaN(d.getTime())) return d;
        return null;
      }
      if (typeof value === 'number') {
        return new Date(value);
      }
      // if it's an object (e.g., { Seconds:..., Nanoseconds:... } or Go's struct), try common props
      if (typeof value === 'object') {
        if ('Time' in value && typeof value.Time === 'string') return parseDate(value.Time);
        if ('seconds' in value) return new Date(value.seconds * 1000);
        if ('sec' in value) return new Date(value.sec * 1000);
        // try JSON stringify fallback
        try {
          const s = JSON.stringify(value);
          const d = new Date(s);
          if (!isNaN(d.getTime())) return d;
        } catch (e) {}
      }
      return null;
    }

    function formatDateForDisplay(value) {
      const d = parseDate(value);
      if (!d) return 'Invalid Date';
      return d.toLocaleString('en-IN', { dateStyle: 'medium', timeStyle: 'short' });
    }

    async function loadMoviesDropdown() {
      const sel = document.getElementById('movie_id');
      sel.innerHTML = '<option>Loading...</option>';
      try {
        const res = await fetch(API_MOVIES, { headers: { 'Authorization': `Bearer ${token}` }});
        const json = await res.json();
        const movies = getShowsFromResponse(json); // reusing helper to pick arrays
        sel.innerHTML = '';
        if (movies.length === 0) {
          sel.innerHTML = '<option disabled>No Movies Found</option>';
          return;
        }
        movies.forEach(m => {
          const opt = document.createElement('option');
          // accept both uppercase/lowercase id fields
          opt.value = getField(m, 'ID', 'id', 'Id') || '';
          opt.textContent = getField(m, 'title', 'Title') || 'Untitled';
          sel.appendChild(opt);
        });
      } catch (err) {
        console.error('loadMoviesDropdown err', err);
        sel.innerHTML = '<option disabled>Error loading movies</option>';
      }
    }

    async function loadShows() {
      const container = document.getElementById('showsContainer');
      container.innerHTML = '<p class="text-muted">Loading shows...</p>';
      try {
        const res = await fetch(API_SHOWS, { headers: { 'Authorization': `Bearer ${token}` }});
        const json = await res.json();
        const shows = getShowsFromResponse(json);
        container.innerHTML = '';
        if (!shows.length) {
          container.innerHTML = '<p class="text-muted">No Shows available</p>';
          return;
        }

        shows.forEach(s => {
          // unify field access
          const id = getField(s, 'id', 'ID', 'Id');
          const movieTitle = getField(s, 'movie', 'Movie') ? getField(s.movie || s.Movie, 'title', 'Title') : (getField(s, 'movie_title', 'movieTitle') || 'Unknown Movie');
          const hall = getField(s, 'hall', 'Hall') || '—';
          const startRaw = getField(s, 'start_time', 'StartTime', 'start', 'Start') || null;
          const seatsTotal = getField(s, 'seats_total', 'SeatsTotal', 'seats') ?? '—';
          const price = getField(s, 'price', 'Price') ?? '—';

          const cardCol = document.createElement('div');
          cardCol.className = 'col-md-4 mb-4';

          const card = document.createElement('div');
          card.className = 'card p-3';

          const title = document.createElement('h5');
          title.textContent = movieTitle;

          const pHall = document.createElement('p');
          pHall.innerHTML = `<strong>Hall:</strong> ${hall}`;

          const pTime = document.createElement('p');
          pTime.innerHTML = `<strong>Time:</strong> ${formatDateForDisplay(startRaw)}`;

          const pSeats = document.createElement('p');
          pSeats.innerHTML = `<strong>Seats:</strong> ${seatsTotal}`; 

          const pPrice = document.createElement('p');
          pPrice.innerHTML = `<strong>Price:</strong> ₹${price}`;

          const btnGroup = document.createElement('div');
          btnGroup.className = 'd-flex gap-2';

          const editBtn = document.createElement('button');
          editBtn.className = 'btn btn-sm btn-primary flex-grow-1';
          editBtn.textContent = 'Edit';
          // attach event listener with closure capturing 's'
          editBtn.addEventListener('click', () => openEditModalWithShowObject(s));

          const delBtn = document.createElement('button');
          delBtn.className = 'btn btn-sm btn-danger flex-grow-1';
          delBtn.textContent = 'Delete';
          delBtn.addEventListener('click', () => deleteShow(id));

          btnGroup.appendChild(editBtn);
          btnGroup.appendChild(delBtn);

          card.appendChild(title);
          card.appendChild(pHall);
          card.appendChild(pTime);
          card.appendChild(pSeats);
          card.appendChild(pPrice);
          card.appendChild(btnGroup);

          cardCol.appendChild(card);
          container.appendChild(cardCol);
        });
      } catch (err) {
        console.error('loadShows error', err);
        container.innerHTML = '<p class="text-danger">Failed to load shows</p>';
      }
    }

    // open modal using the show object (safer than string interpolation)
    function openEditModalWithShowObject(s) {
      const id = getField(s, 'id', 'ID', 'Id');
      const hall = getField(s, 'hall', 'Hall') || '';
      const startRaw = getField(s, 'start_time', 'StartTime', 'start', 'Start') || null;
      const seatsTotal = getField(s, 'seats_total', 'SeatsTotal', 'seats') ?? '';
      const price = getField(s, 'price', 'Price') ?? '';

      const dt = parseDate(startRaw);

      document.getElementById('edit_id').value = id;
      document.getElementById('edit_hall').value = hall;
      document.getElementById('edit_date').value = dt ? dt.toISOString().split('T')[0] : '';
      document.getElementById('edit_time').value = dt ? dt.toTimeString().slice(0,5) : '';
      document.getElementById('edit_price').value = price;
      document.getElementById('edit_seats').value = seatsTotal;

      const modalEl = document.getElementById('editShowModal');
      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    }

    // Create show (POST)
    document.getElementById('showForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const movie_id = parseInt(document.getElementById('movie_id').value);
      const hall = document.getElementById('hall').value;
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      const seats_total = parseInt(document.getElementById('seats_total').value);
      const price = parseFloat(document.getElementById('price').value);

      const start_time = (date && time) ? `${date}T${time}` : null;

      try {
        const res = await fetch(API_SHOWS, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ movie_id, hall, start_time, seats_total, price })
        });
        if (res.ok) {
          alert('Show added successfully');
          document.getElementById('showForm').reset();
          loadShows();
        } else {
          const json = await res.json().catch(()=>({}));
          alert(json.error || 'Failed to add show');
        }
      } catch (err) {
        console.error('add show error', err);
        alert('Failed to add show (network error)');
      }
    });

    // Update show (PUT)
    document.getElementById('editShowForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = document.getElementById('edit_id').value;
      const hall = document.getElementById('edit_hall').value;
      const date = document.getElementById('edit_date').value;
      const time = document.getElementById('edit_time').value;
      const price = parseFloat(document.getElementById('edit_price').value);
      const seats_total = parseInt(document.getElementById('edit_seats').value);
      const start_time = (date && time) ? `${date}T${time}` : null;

      try {
        const res = await fetch(`${API_SHOWS}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ hall, start_time, seats_total, price })
        });
        if (res.ok) {
          alert('Show updated successfully');
          bootstrap.Modal.getInstance(document.getElementById('editShowModal')).hide();
          loadShows();
        } else {
          const json = await res.json().catch(()=>({}));
          alert(json.error || 'Failed to update show');
        }
      } catch (err) {
        console.error('update show err', err);
        alert('Failed to update show (network error)');
      }
    });

    // delete
    async function deleteShow(id) {
      if (!confirm('Are you sure to delete this show?')) return;
      try {
        const res = await fetch(`${API_SHOWS}/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (res.ok) {
          alert('Deleted successfully');
          loadShows();
        } else {
          const json = await res.json().catch(()=>({}));
          alert(json.error || 'Failed to delete show');
        }
      } catch (err) {
        console.error('delete show err', err);
        alert('Failed to delete show (network error)');
      }
    }

    // initial load
    loadMoviesDropdown();
    loadShows();
  </script>
</body>
</html>
